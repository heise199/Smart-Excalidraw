# 模型输入功能更新日志

## [2025-01-XX] - 支持用户自定义模型输入

### 变更说明

所有模型列表获取函数现在都支持用户手动输入模型名称，而不是只返回硬编码的列表。

### 主要变更

#### 1. 模型列表获取策略

**之前：**
- Anthropic、Google 返回硬编码的模型列表
- Mistral、Qwen、Ollama 失败时返回硬编码列表

**现在：**
- 所有提供商都先尝试从 API 获取模型列表
- 如果 API 获取失败，返回**空列表**，让用户手动输入
- 前端自动切换到手动输入模式

#### 2. 更新的函数

- `fetch_anthropic_models()` - 尝试从 API 获取，失败返回空列表
- `fetch_google_models()` - 尝试从 API 获取，失败返回空列表
- `fetch_mistral_models()` - 失败时返回空列表（之前返回硬编码列表）
- `fetch_qwen_models()` - 失败时返回空列表（之前返回硬编码列表）
- `fetch_ollama_models()` - 失败时返回空列表（之前返回硬编码列表）

#### 3. API 端点优化

- `GET /api/v1/models` - 获取失败时返回空列表，而不是抛出异常
- 这样前端可以正常显示手动输入框

#### 4. 前端优化

- 模型列表为空时，自动切换到手动输入模式
- 当前模型不在列表中时，自动切换到手动输入模式
- Ollama 不需要 API key 的检查优化

### 用户体验改进

1. **更灵活** - 用户可以输入任何模型名称，不受限于预设列表
2. **更准确** - 如果 API 无法获取列表，用户可以手动输入正确的模型名称
3. **更友好** - 自动切换输入模式，减少用户操作

### 使用场景

#### 场景 1: API 无法获取模型列表
- 用户配置 Anthropic API
- 点击"加载可用模型"
- API 返回空列表（Anthropic 可能没有公开的模型列表端点）
- 系统自动切换到手动输入模式
- 用户输入：`claude-3-5-sonnet-20241022`

#### 场景 2: 使用自定义模型名称
- 用户使用代理服务，模型名称可能不同
- 即使 API 返回了模型列表，用户也可以手动输入自定义名称
- 系统会保留用户输入的值

#### 场景 3: 模型列表获取失败
- 网络问题或 API 错误导致获取失败
- 系统返回空列表，不抛出异常
- 用户可以继续手动输入模型名称

### 技术细节

#### 后端变更

```python
# 之前
async def fetch_anthropic_models(...):
    return [硬编码列表]

# 现在
async def fetch_anthropic_models(...):
    try:
        # 尝试从 API 获取
        return [从 API 获取的列表]
    except:
        # 失败时返回空列表
        return []
```

#### 前端变更

```javascript
// 模型列表为空时，自动使用手动输入模式
if (models.length === 0) {
  setUseCustomModel(true);
}
```

### 兼容性

- ✅ 向后兼容 - 如果 API 成功获取模型列表，行为与之前一致
- ✅ 不影响现有配置 - 已保存的配置继续有效
- ✅ 用户体验提升 - 更灵活，更友好

### 相关文档

- [模型输入指南](../docs/model-input-guide.md) - 详细的使用指南和常用模型名称





