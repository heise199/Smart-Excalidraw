# 模型输入功能更新总结

## 问题

之前的实现中，某些提供商（如 Anthropic、Google）返回硬编码的模型列表，不允许用户自定义输入。这限制了用户的灵活性，特别是：
- 使用代理服务时，模型名称可能不同
- API 无法获取模型列表时，用户无法输入
- 新模型发布时，硬编码列表无法及时更新

## 解决方案

### 1. 后端变更

所有模型列表获取函数现在都：
1. **优先尝试从 API 获取** - 如果提供商支持模型列表 API，先尝试获取
2. **失败时返回空列表** - 不再返回硬编码列表，让用户手动输入
3. **不抛出异常** - API 获取失败时返回空列表，而不是抛出异常

#### 更新的函数

**`fetch_anthropic_models()`**
- 之前：直接返回硬编码列表
- 现在：尝试从 API 获取，失败返回空列表

**`fetch_google_models()`**
- 之前：直接返回硬编码列表
- 现在：尝试从 API 获取，失败返回空列表

**`fetch_mistral_models()`**
- 之前：失败时返回硬编码列表
- 现在：失败时返回空列表

**`fetch_qwen_models()`**
- 之前：失败时返回硬编码列表
- 现在：失败时返回空列表

**`fetch_ollama_models()`**
- 之前：失败时返回硬编码列表
- 现在：失败时返回空列表

### 2. API 端点优化

**`GET /api/v1/models`**
- 之前：获取失败时抛出异常
- 现在：获取失败时返回空列表（`{"models": []}`）

这样前端可以正常处理，显示手动输入框。

### 3. 前端优化

**`components/ConfigModal.jsx`**

1. **自动切换输入模式**
   - 模型列表为空时，自动切换到手动输入模式
   - 当前模型不在列表中时，自动切换到手动输入模式

2. **Ollama 支持优化**
   - Ollama 不需要 API key，更新了验证逻辑

3. **用户体验改进**
   - 模型列表为空时，直接显示手动输入框
   - 用户可以选择"从列表选择"或"手动输入"

## 工作流程

### 场景 1: API 成功获取模型列表

```
用户点击"加载可用模型"
  ↓
后端尝试从 API 获取
  ↓
成功获取模型列表
  ↓
前端显示下拉选择框
  ↓
用户从列表中选择
```

### 场景 2: API 获取失败

```
用户点击"加载可用模型"
  ↓
后端尝试从 API 获取
  ↓
获取失败（网络错误、API 不支持等）
  ↓
后端返回空列表 []
  ↓
前端自动切换到手动输入模式
  ↓
用户手动输入模型名称
```

### 场景 3: 用户主动选择手动输入

```
用户点击"手动输入"单选按钮
  ↓
前端切换到手动输入模式
  ↓
用户输入模型名称
  ↓
保存配置
```

## 代码变更

### 后端

```python
# common.py - 示例：Anthropic
async def fetch_anthropic_models(base_url: str, api_key: str):
    try:
        # 尝试从 API 获取
        response = await client.get(url, headers={...})
        # 解析并返回模型列表
        return models
    except Exception:
        # 失败时返回空列表
        return []
```

### 前端

```javascript
// ConfigModal.jsx
if (models.length === 0) {
  // 模型列表为空，使用手动输入模式
  setUseCustomModel(true);
}
```

## 优势

1. **更灵活** - 用户可以输入任何模型名称
2. **更准确** - 不依赖可能过时的硬编码列表
3. **更友好** - 自动切换输入模式，减少用户操作
4. **更可靠** - API 失败时仍可使用，不阻塞用户

## 兼容性

- ✅ 向后兼容 - 如果 API 成功获取，行为与之前一致
- ✅ 不影响现有配置 - 已保存的配置继续有效
- ✅ 用户体验提升 - 更灵活，更友好

## 测试建议

1. **测试 API 成功场景**
   - 配置 OpenAI，应该能获取模型列表
   - 配置 Ollama（本地运行），应该能获取模型列表

2. **测试 API 失败场景**
   - 配置 Anthropic，应该显示手动输入框
   - 配置错误的 API key，应该显示手动输入框

3. **测试手动输入**
   - 输入正确的模型名称，应该能正常使用
   - 输入错误的模型名称，应该在生成时返回错误

## 相关文档

- [模型输入指南](../docs/model-input-guide.md) - 详细使用指南
- [CHANGELOG_MODEL_INPUT.md](./CHANGELOG_MODEL_INPUT.md) - 更新日志





