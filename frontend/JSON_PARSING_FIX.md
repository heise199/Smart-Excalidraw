# JSON 解析修复说明

## 问题

LLM 生成的响应中可能包含思考内容（如 `<think>`, `<think>` 等），这些内容不是 JSON，导致解析失败。

## 解决方案

### 1. 移除思考标签

系统现在会自动识别并移除以下思考标签：

- `<thinking>...</thinking>`
- `<reasoning>...</reasoning>`
- `<think>...</think>`
- `<redacted_reasoning/>` (自闭合)
- `<thought>...</thought>`
- `<analysis>...</analysis>`
- 任何包含 `thinking`、`reasoning` 或 `redacted` 的标签
- HTML 注释 `<!-- ... -->`

### 2. 多层清理策略

#### Step 1: 移除思考标签
- 移除所有已知的思考标签及其内容
- 移除自闭合标签
- 移除 HTML 注释

#### Step 2: 移除 Markdown 包装
- 移除代码块标记 (```json, ```javascript 等)

#### Step 3: 提取 JSON 数组
- 从响应中提取 JSON 数组部分
- 如果找不到数组，尝试提取对象并包装成数组

#### Step 4: 移除数组前的非 JSON 内容
- 找到第一个 `[` 或 `{`
- 移除之前的所有内容（可能是思考内容）

#### Step 5: 修复格式错误
- 移除孤立字符串
- 修复不完整的对象

#### Step 6: 最终清理
- 移除数组前包含标签的内容
- 移除未闭合的标签

#### Step 7-10: 解析和修复
- 尝试解析 JSON
- 如果失败，修复未转义的引号
- 修复不完整的 JSON
- 提取有效部分

### 3. 错误处理

如果所有修复尝试都失败：
- 返回空数组 `[]` 而不是崩溃
- 记录详细的错误信息
- 显示处理后的代码前 500 个字符用于调试

## 支持的标签格式

### 完整标签对
- `<thinking>...</thinking>`
- `<think>...</think>`

### 自闭合标签
- `<redacted_reasoning/>`
- `<think/>`

### 未闭合标签
- `<think>` (只有开始标签)
- `<think>` (只有开始标签)

## 处理流程

```
LLM 响应
  ↓
移除思考标签 (Step 1)
  ↓
移除 Markdown 包装 (Step 2)
  ↓
提取 JSON 数组 (Step 3)
  ↓
移除数组前的非 JSON 内容 (Step 4)
  ↓
修复格式错误 (Step 5)
  ↓
最终清理 (Step 6)
  ↓
尝试解析 (Step 7)
  ↓ (失败)
修复引号 (Step 8)
  ↓
修复不完整 JSON (Step 9)
  ↓
最终清理标签 (Step 9)
  ↓
尝试解析 (Step 10)
  ↓ (失败)
提取有效部分
  ↓
返回结果或空数组
```

## 注意事项

1. **标签可能在 JSON 中间** - 系统会在多个步骤中清理
2. **未闭合标签** - 系统会移除所有未闭合的思考标签
3. **错误恢复** - 如果无法修复，返回空数组而不是崩溃
4. **调试信息** - 失败时会记录处理后的代码前 500 个字符

## 测试建议

如果仍然遇到问题，请检查：
1. 浏览器控制台的错误信息
2. 处理后的代码前 500 个字符
3. 是否还有其他未识别的标签格式





